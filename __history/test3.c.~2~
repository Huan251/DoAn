#include <16F887.h>
#device *=16 adc=8
#FUSES NOWDT, HS, NOPUT, NODEBUG, NOBROWNOUT, NOLVP, NOCPD, NOWRT
#use delay(clock = 20000000)

// I2C master dùng cho LCD
#use i2c(MASTER, SDA=PIN_C4, SCL=PIN_C3, FORCE_SW)

#include <string.h>
#include <stdlib.h>
#include <stdio.h>

// LCD I2C
#include "I2C_LCD.c"   // nhúng thý vi?n b?n ð? g?i

#define LCD_ADDR 0x4E

// ================== MA TR?N 4x4 ==================
#define HANG_1 PIN_B0
#define HANG_2 PIN_B1
#define HANG_3 PIN_B2
#define HANG_4 PIN_B3

#define COT_1 PIN_B4
#define COT_2 PIN_B5
#define COT_3 PIN_B6
#define COT_4 PIN_B7


// LAYOUT PHÍM
const char PHIM_THUONG[4][4] = {
    {'7','8','9','/'}, 
    {'4','5','6','*'}, 
    {'1','2','3','-'}, 
    {'0','=','S','+'}
};

const char PHIM_SHIFT[4][4] = {
    {'C','A','I','J'},
    {'!','^','D','.'},
    {'(',')','.','.'},
    {'.','.',' ','.'}
};

// ================== BI?N TOÁN TÍNH ==================

long int ANS = 0;
long int luu_gia_tri_I = 0;
long int luu_gia_tri_J = 0;
long int loi = 0;
int1 shift_mode = 0;

void cap_nhat_shift_lcd() {
    if(shift_mode) {
        LCD_Goto(16,1);
        LCD_Out('S');
    } else {
        LCD_Goto(16,1);
        LCD_Out(' ');
    }
}
// ================== KHAI BÁO HÀM ==================
char doc_phim() {
    int8 hang, cot;
    char phim = 0;

    for(hang = 0; hang < 4; hang++) {

        output_high(HANG_1);
        output_high(HANG_2);
        output_high(HANG_3);
        output_high(HANG_4);

        switch(hang) {
            case 0: output_low(HANG_1); break;
            case 1: output_low(HANG_2); break;
            case 2: output_low(HANG_3); break;
            case 3: output_low(HANG_4); break;
        }

        delay_us(10);

        for(cot = 0; cot < 4; cot++) {
            int1 nhan = 0;

            switch(cot) {
                case 0: nhan = !input(COT_1); break;
                case 1: nhan = !input(COT_2); break;
                case 2: nhan = !input(COT_3); break;
                case 3: nhan = !input(COT_4); break;
            }

            if(nhan) {

    // ===== PHÍM SHIFT (V? TRÍ C? Ð?NH) =====
    if(PHIM_THUONG[hang][cot] == 'S') {
        return 'S';
    }

    // ===== PHÍM KHÁC =====
    if(shift_mode)
        phim = PHIM_SHIFT[hang][cot];
    else
        phim = PHIM_THUONG[hang][cot];

    return phim;
}

        }
    }
    return 0;
}

// ============= CÁC HÀM TÍNH TOÁN (GI? NGUYÊN 100%) =============
long int uu_tien_toan_tu(char toan_tu) {
    if (toan_tu == '+' || toan_tu == '-') return 1;
    if (toan_tu == '*' || toan_tu == '/') return 2;
    if (toan_tu == '^') return 3;
    if (toan_tu == '!') return 4;
    return 0;
}

long int phep_toan(char c) {
    return (c == '+' || c == '-' || c == '*' || c == '/' || c == '^');
}

long int tinh_luy_thua(long int co_so, long int so_mu) {
    if (co_so == 0){
      if (so_mu > 0) return 0;
      else if (so_mu == 0) return 1;
      else {
         loi = 1;
         return 0;
      }
    }
    else if (co_so == 1) return 1;
    else if (co_so == -1) {
        if (so_mu % 2 == 0) return 1;
        else return -1;
    }
    if(so_mu < 0) return 0;
    long int ket_qua = 1;
    if (co_so != 0 && so_mu > 0) {
        if (so_mu >= 15 && co_so >= 2) {
            loi = 2;
            return 0;
        }
        if (so_mu >= 1 && co_so > 181) {
            loi = 2;
            return 0;
        }
    }
    for (long int i = 0; i < so_mu; i++) {
        if (co_so != 0 && (long int)
        
        767 / abs(co_so) < abs(ket_qua)) {
            loi = 2;
            return 0;
        }
        ket_qua *= co_so;
    }
    return ket_qua;
}

long int tinh_toan(long int so_a, long int so_b, char toan_tu) {
    switch (toan_tu) {
        case '+': return so_a + so_b;
        case '-': return so_a - so_b;
        case '*': return so_a * so_b;
        case '/':
            if (so_b == 0) {
                loi = 1;
                return 0;
            }
            return so_a / so_b;
        case '^': return tinh_luy_thua(so_a, so_b);
    }
    return 0;
}

long int tinh_giai_thua(long int so_n) {
    if (so_n < 0) {
        loi = 1;
        return 0;
    }
    if (so_n == 0 || so_n == 1) return 1;
    if (so_n > 7) {
        loi = 2;
        return 0;
    }
    long int ket_qua = 1;
    for (long int i = 2; i <= so_n; i++) {
        ket_qua *= i;
    }
    return ket_qua;
}

long int tinh_bieu_thuc(char *bieu_thuc) {
    long int val[20];
    char op[20];
    int vtop = -1, otop = -1;
    long int i;

    loi = 0;

    for (i = 0; i < strlen(bieu_thuc); i++) {
        char c = bieu_thuc[i];
        if (c == ' ') continue;

        /* ===== TOÁN T? ÐÕN '-' ===== */
        if (c == '-' && (i == 0 || bieu_thuc[i-1] == '(' || phep_toan(bieu_thuc[i-1]))) {
            val[++vtop] = 0;
            op[++otop] = '-';
            continue;
        }

        /* ===== S? ===== */
        if (c >= '0' && c <= '9') {
            long int num = 0;
            while (i < strlen(bieu_thuc) && bieu_thuc[i] >= '0' && bieu_thuc[i] <= '9') {
                num = num * 10 + (bieu_thuc[i] - '0');
                i++;
            }
            val[++vtop] = num;
            i--;
        }

        /* ===== NGO?C ===== */
        else if (c == '(') {
            op[++otop] = '(';
        }
        else if (c == ')') {
            while (otop != -1 && op[otop] != '(') {
                if (vtop < 1) { loi = 1; return 0; }
                long int b = val[vtop--];
                long int a = val[vtop--];
                val[++vtop] = tinh_toan(a, b, op[otop--]);
                if (loi) return 0;
            }
            if (otop == -1) { loi = 1; return 0; }
            otop--; // b? '('
        }

        /* ===== GIAI TH?A ===== */
       else if (c == '!') {

             // không có toán h?ng
             if (vtop < 0) {
                 loi = 1;
                 return 0;
             }
         
//!             // ? n?u phía trý?c là toán t? tr? ðõn ? l?i cú pháp (-5!)
//!             if (otop >= 0 && op[otop] == '-') {
//!                 loi = 1;
//!                 return 0;
//!             }
         
             // ? v?n c?m giai th?a s? âm d?ng (-5)!
             if (val[vtop] < 0) {
                 loi = 1;
                 return 0;
             }
         
             val[vtop] = tinh_giai_thua(val[vtop]);
             if (loi) return 0;
         }


        /* ===== TOÁN T? ===== */
        else if (phep_toan(c)) {
            if (c == '^') {
                // ^ k?t h?p ph?i
                while (otop != -1 && op[otop] != '(' &&
                       uu_tien_toan_tu(op[otop]) > uu_tien_toan_tu('^')) {
                    if (vtop < 1) { loi = 1; return 0; }
                    long int b = val[vtop--];
                    long int a = val[vtop--];
                    val[++vtop] = tinh_toan(a, b, op[otop--]);
                    if (loi) return 0;
                }
            } else {
                while (otop != -1 && op[otop] != '(' &&
                       uu_tien_toan_tu(op[otop]) >= uu_tien_toan_tu(c)) {
                    if (vtop < 1) { loi = 1; return 0; }
                    long int b = val[vtop--];
                    long int a = val[vtop--];
                    val[++vtop] = tinh_toan(a, b, op[otop--]);
                    if (loi) return 0;
                }
            }
            op[++otop] = c;
        }
        else {
            loi = 1;
            return 0;
        }
    }

    while (otop != -1) {
        if (vtop < 1) { loi = 1; return 0; }
        long int b = val[vtop--];
        long int a = val[vtop--];
        val[++vtop] = tinh_toan(a, b, op[otop--]);
        if (loi) return 0;
    }

    if (vtop == 0) return val[0];
    loi = 1;
    return 0;
}

int la_mu_chan(char *bt) {
    int i = 0;
    while (bt[i] && bt[i] != '^') i++;
    if (bt[i] != '^') return 1; // không có m?
    i++;
    int mu = 0;
    while (bt[i] >= '0' && bt[i] <= '9') {
        mu = mu * 10 + (bt[i] - '0');
        i++;
    }
    return (mu % 2 == 0);
}


// ================== MAIN ==================
void main() {
    delay_ms(500);
    setup_adc_ports(NO_ANALOGS);
    setup_adc(ADC_OFF);
    char phim;
    char bieu_thuc[15];
    int8 vi_tri = 0;
    int1 da_xong = 0;
    int1 man_hinh_ban_dau = 1;
    char buf[12];

    set_tris_a(0xFF);
    set_tris_b(0xF0);
    set_tris_c(0xFF);
  
    set_tris_e(0xFF);
    port_b_pullups(TRUE);

    LCD_Begin(LCD_ADDR);
    LCD_Cmd(LCD_CLEAR);

    // màn h?nh ban ð?u
    LCD_Goto(1,1);
    LCD_Out('M'); LCD_Out('A'); LCD_Out('Y'); LCD_Out(' ');
    LCD_Out('T'); LCD_Out('I'); LCD_Out('N'); LCD_Out('H');
    LCD_Goto(1,2);
    LCD_Out('N'); LCD_Out('H'); LCD_Out('A'); LCD_Out('P');
    LCD_Out(' '); LCD_Out('B'); LCD_Out('I'); LCD_Out('E');
    LCD_Out('U'); LCD_Out(' '); LCD_Out('T'); LCD_Out('H');
    LCD_Out('U'); LCD_Out('C');

    bieu_thuc[0] = '\0';
    while(doc_phim() != 0);

    while(TRUE) {
        phim = doc_phim();
        if(phim) {
            while(doc_phim() == phim);
            delay_ms(200);
            if(phim == 'S') {
    shift_mode = !shift_mode;   // toggle

    cap_nhat_shift_lcd();       // hi?n / xóa ch? S

    while(doc_phim() == 'S');  // ch? nh? phím
    continue;                  // KHÔNG cho rõi xu?ng nh?p li?u
}

// ===== T?T SHIFT SAU 1 PHÍM =====
if(shift_mode) {
    shift_mode = 0;
    cap_nhat_shift_lcd();
}
            // xóa màn h?nh ban ð?u khi b?m phím ð?u tiên
            if(man_hinh_ban_dau && phim != 'C') {
                LCD_Goto(1,1); for(int i=0;i<16;i++) LCD_Out(' ');
                LCD_Goto(1,2); for(int i=0;i<16;i++) LCD_Out(' ');
                man_hinh_ban_dau = 0;
            }
            // CLEAR
           if(phim == 'C') {

    shift_mode = 0;
    cap_nhat_shift_lcd();

    LCD_Cmd(LCD_CLEAR);
    cap_nhat_shift_lcd();

    LCD_Goto(1,1);
    LCD_Out('M'); LCD_Out('A'); LCD_Out('Y'); LCD_Out(' ');
    LCD_Out('T'); LCD_Out('I'); LCD_Out('N'); LCD_Out('H');
    LCD_Goto(1,2);
    LCD_Out('N'); LCD_Out('H'); LCD_Out('A'); LCD_Out('P');
    LCD_Out(' '); LCD_Out('B'); LCD_Out('I'); LCD_Out('E');
    LCD_Out('U'); LCD_Out(' '); LCD_Out('T'); LCD_Out('H');
    LCD_Out('U'); LCD_Out('C');

    vi_tri = 0;
    bieu_thuc[0] = '\0';
    da_xong = 0;
    man_hinh_ban_dau = 1;
}

            // BACKSPACE
            else if(phim == 'D') {
                if(vi_tri > 0) {
                    vi_tri--;
                    bieu_thuc[vi_tri] = '\0';
                    LCD_Goto(vi_tri + 1, 1);
                    LCD_Out(' ');
                    LCD_Goto(vi_tri + 1, 1);
                }
            }

            // I
            else if(phim == 'I') {
                if(da_xong) {
                    luu_gia_tri_I = ANS;
                    LCD_Cmd(LCD_CLEAR);
                    LCD_Goto(1,1);
                    LCD_Out('D'); LCD_Out('A'); LCD_Out(' ');
                    LCD_Out('L'); LCD_Out('U'); LCD_Out('U');
                    LCD_Out(' '); LCD_Out('V'); LCD_Out('A'); LCD_Out('O');
                    LCD_Out(' '); LCD_Out('I');
                    delay_ms(1000);
                    LCD_Cmd(LCD_CLEAR);
                    man_hinh_ban_dau = 1;
                    vi_tri = 0;
                    da_xong = 0;
                } else {
                    sprintf(buf, "%ld", luu_gia_tri_I);
                    for(int i=0; buf[i] && vi_tri < 14; i++) {
                        bieu_thuc[vi_tri++] = buf[i];
                        bieu_thuc[vi_tri] = '\0';
                        LCD_Goto(vi_tri,1);
                        LCD_Out(buf[i]);
                    }
                }
            }

            // J
            else if(phim == 'J') {
                if(da_xong) {
                    luu_gia_tri_J = ANS;
                    LCD_Cmd(LCD_CLEAR);
                    LCD_Goto(1,1);
                    LCD_Out('D'); LCD_Out('A'); LCD_Out(' ');
                    LCD_Out('L'); LCD_Out('U'); LCD_Out('U');
                    LCD_Out(' '); LCD_Out('V'); LCD_Out('A'); LCD_Out('O');
                    LCD_Out(' '); LCD_Out('J');
                    delay_ms(1000);
                    LCD_Cmd(LCD_CLEAR);
                    man_hinh_ban_dau = 1;
                    vi_tri = 0;
                    da_xong = 0;
                } else {
                    sprintf(buf, "%ld", luu_gia_tri_J);
                    for(int i=0; buf[i] && vi_tri < 14; i++) {
                        bieu_thuc[vi_tri++] = buf[i];
                        bieu_thuc[vi_tri] = '\0';
                        LCD_Goto(vi_tri,1);
                        LCD_Out(buf[i]);
                    }
                }
            }

            // ANS
            else if(phim == 'A') {

                // n?u v?a tính xong ? clear nhý phím s?
                if(da_xong) {
                    LCD_Cmd(LCD_CLEAR);
                    vi_tri = 0;
                    bieu_thuc[0] = '\0';
                    da_xong = 0;
                }
            
                sprintf(buf, "%ld", ANS);
                for(int i=0; buf[i] && vi_tri < 14; i++) {
                    bieu_thuc[vi_tri++] = buf[i];
                    bieu_thuc[vi_tri] = '\0';
                    LCD_Goto(vi_tri,1);
                    LCD_Out(buf[i]);
                }
            }

// ! (GIAI TH?A SAU KHI =)
else if(phim == '!' && da_xong) {

    // clear màn h?nh k?t qu?
    LCD_Cmd(LCD_CLEAR);

    // ðýa ANS vào l?i bi?u th?c
    sprintf(buf, "%ld", ANS);
    vi_tri = 0;
    for(int i = 0; buf[i] && vi_tri < 14; i++) {
        bieu_thuc[vi_tri++] = buf[i];
        bieu_thuc[vi_tri] = '\0';
        LCD_Goto(vi_tri, 1);
        LCD_Out(buf[i]);
    }

    // thêm d?u !
    if(vi_tri < 14) {
        bieu_thuc[vi_tri++] = '!';
        bieu_thuc[vi_tri] = '\0';
        LCD_Goto(vi_tri, 1);
        LCD_Out('!');
    }

    da_xong = 0;   // quay v? tr?ng thái nh?p
}


            // =
           else if(phim == '=') {
    if(vi_tri > 0) {

        int am_trong_ngoac = 0;
        if(bieu_thuc[0] == '(' && bieu_thuc[1] == '-') {
            am_trong_ngoac = 1;
        }

        long int kq = tinh_bieu_thuc(bieu_thuc);

        LCD_Cmd(LCD_CLEAR);
        LCD_Goto(1,1);
        LCD_Out('K'); LCD_Out('E'); LCD_Out('T');
        LCD_Out(' '); LCD_Out('Q'); LCD_Out('U'); LCD_Out('A');
        LCD_Goto(1,2);
        LCD_Out('=');

        if(loi == 0) {
            if(am_trong_ngoac && !la_mu_chan(bieu_thuc)) {
                kq = 0 - kq;
            }
            sprintf(buf, "%ld", kq);
            for(int i=0; buf[i]; i++) LCD_Out(buf[i]);
            ANS = kq;
        } else {
            LCD_Out('E'); LCD_Out('R'); LCD_Out('R');
        }
        da_xong = 1;
    }
}


            // TOÁN T? SAU KHI =
            else if(da_xong && (phim=='+' || phim=='-' || phim=='*' || phim=='/')) {
                LCD_Cmd(LCD_CLEAR);
                sprintf(buf, "%ld", ANS);
                vi_tri = 0;
                for(int i=0; buf[i] && vi_tri < 14; i++) {
                    bieu_thuc[vi_tri++] = buf[i];
                    bieu_thuc[vi_tri] = '\0';
                    LCD_Goto(vi_tri,1);
                    LCD_Out(buf[i]);
                }
                if(vi_tri < 14) {
                    bieu_thuc[vi_tri++] = phim;
                    bieu_thuc[vi_tri] = '\0';
                    LCD_Goto(vi_tri,1);
                    LCD_Out(phim);
                }
                da_xong = 0;
            }

            // NH?P B?NH THÝ?NG
            else {
                if(da_xong) {
                    LCD_Cmd(LCD_CLEAR);
                    vi_tri = 0;
                    bieu_thuc[0] = '\0';
                    da_xong = 0;
                }
                if(vi_tri < 14) {
                    bieu_thuc[vi_tri++] = phim;
                    bieu_thuc[vi_tri] = '\0';
                    LCD_Goto(vi_tri,1);
                    LCD_Out(phim);
                }
            }
        }
    }
}

